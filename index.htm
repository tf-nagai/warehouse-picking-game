<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ÂÄâÂ∫´„Éî„ÉÉ„Ç≠„É≥„Ç∞„Ç≤„Éº„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Segoe UI', 'Hiragino Sans', sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            max-width: 100vw;
            max-height: 100vh;
        }
        
        h1 {
            color: #ffd700;
            font-size: 24px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        #gameCanvas {
            border: 3px solid #ffd700;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            cursor: pointer;
            outline: none;
            max-width: 100%;
            max-height: 55vh;
        }
        
        .controls {
            color: #ccc;
            font-size: 11px;
            text-align: center;
        }
        
        .controls span {
            color: #ffd700;
            font-weight: bold;
        }

        .virtual-controls {
            display: none;
            position: fixed;
            bottom: 10px;
            left: 0;
            right: 0;
            padding: 0 15px;
        }
        
        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dpad {
            position: relative;
            width: 130px;
            height: 130px;
        }
        
        .dpad-btn {
            position: absolute;
            width: 44px;
            height: 44px;
            background: rgba(255, 215, 0, 0.7);
            border: 2px solid #ffd700;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: #1a1a2e;
            font-weight: bold;
            touch-action: none;
        }
        
        .dpad-btn:active, .dpad-btn.active {
            background: #ffd700;
            transform: scale(0.95);
        }
        
        .dpad-up { top: 0; left: 50%; transform: translateX(-50%); }
        .dpad-down { bottom: 0; left: 50%; transform: translateX(-50%); }
        .dpad-left { left: 0; top: 50%; transform: translateY(-50%); }
        .dpad-right { right: 0; top: 50%; transform: translateY(-50%); }
        
        .dpad-up:active, .dpad-up.active { transform: translateX(-50%) scale(0.95); }
        .dpad-down:active, .dpad-down.active { transform: translateX(-50%) scale(0.95); }
        .dpad-left:active, .dpad-left.active { transform: translateY(-50%) scale(0.95); }
        .dpad-right:active, .dpad-right.active { transform: translateY(-50%) scale(0.95); }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .action-btn {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #4CAF50, #2E7D32);
            border: 3px solid #81C784;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            color: #fff;
            font-weight: bold;
            text-align: center;
            touch-action: none;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .action-btn:active, .action-btn.active {
            transform: scale(0.95);
        }
        
        .urgent-btns {
            display: none;
            position: fixed;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            gap: 20px;
            z-index: 200;
        }
        
        .urgent-choice-btn {
            padding: 20px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            touch-action: none;
        }
        
        .accept-btn {
            background: #FF5252;
            color: white;
        }
        
        .reject-btn {
            background: #666;
            color: white;
        }
        
        .start-btn {
            position: fixed;
            bottom: 180px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 40px;
            background: #ffd700;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #1a1a2e;
            display: none;
            touch-action: none;
        }
        
        .sound-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 12px;
            background: rgba(255, 215, 0, 0.8);
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            z-index: 100;
        }
        
        @media (max-width: 950px) {
            .virtual-controls, .start-btn {
                display: flex;
            }
            .controls {
                display: none;
            }
            h1 {
                font-size: 16px;
            }
            #gameCanvas {
                max-height: 45vh;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üè≠ ÂÄâÂ∫´„Éî„ÉÉ„Ç≠„É≥„Ç∞</h1>
        <canvas id="gameCanvas" tabindex="0"></canvas>
        <div class="controls">
            <span>‚Üë‚Üì‚Üê‚Üí/WASD</span>ÁßªÂãï | <span>SPACE</span>„Éî„ÉÉ„ÇØ/Á¥çÂìÅ | <span>M</span>BGM | Á∑äÊÄ•ÊôÇ<span>Y/N</span>„ÅßÈÅ∏Êäû
        </div>
    </div>
    
    <button class="sound-toggle" id="soundToggle">üîä</button>
    <button class="start-btn" id="startBtn">üéÆ „Çπ„Çø„Éº„Éà</button>
    
    <div class="urgent-btns" id="urgentBtns">
        <button class="urgent-choice-btn accept-btn" id="acceptBtn">üö® Á∑äÊÄ•„ÇíÂèó„Åë„Çã (Y)</button>
        <button class="urgent-choice-btn reject-btn" id="rejectBtn">Á∂öË°å„Åô„Çã (N)</button>
    </div>
    
    <div class="virtual-controls" id="virtualControls">
        <div class="control-row">
            <div class="dpad">
                <div class="dpad-btn dpad-up" data-dir="up">‚ñ≤</div>
                <div class="dpad-btn dpad-down" data-dir="down">‚ñº</div>
                <div class="dpad-btn dpad-left" data-dir="left">‚óÄ</div>
                <div class="dpad-btn dpad-right" data-dir="right">‚ñ∂</div>
            </div>
            <div class="action-buttons">
                <div class="action-btn" id="actionBtn">üì¶<br>„Éî„ÉÉ„ÇØ</div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const soundToggle = document.getElementById('soundToggle');
        const actionBtn = document.getElementById('actionBtn');
        const urgentBtns = document.getElementById('urgentBtns');
        const acceptBtn = document.getElementById('acceptBtn');
        const rejectBtn = document.getElementById('rejectBtn');

        // ÁîªÈù¢„Éª„Éû„ÉÉ„Éó„Çµ„Ç§„Ç∫
        const SCREEN_WIDTH = 950;
        const SCREEN_HEIGHT = 600;
        const MAP_WIDTH = 1900;
        const MAP_HEIGHT = 1500;
        
        canvas.width = SCREEN_WIDTH;
        canvas.height = SCREEN_HEIGHT;

        // „Ç¢„Ç§„ÉÜ„É†„ÅÆÁ®ÆÈ°û
        const ITEM_TYPES = [
            { emoji: 'üëí', name: 'Â∏ΩÂ≠ê', color: '#FFE4B5' },
            { emoji: 'üëï', name: '„Ç∑„É£„ÉÑ', color: '#87CEEB' },
            { emoji: 'üëñ', name: '„Ç∫„Éú„É≥', color: '#4169E1' },
            { emoji: 'üß¶', name: 'Èù¥‰∏ã', color: '#FFF0F5' },
            { emoji: 'üëü', name: 'Èù¥', color: '#DEB887' },
            { emoji: 'üåÇ', name: 'ÂÇò', color: '#9370DB' },
            { emoji: 'üëú', name: '„Éê„ÉÉ„Ç∞', color: '#F4A460' }
        ];

        // „Ç≤„Éº„É†Áä∂ÊÖã
        const GAME_STATE = { TITLE: 0, PLAYING: 1, GAMEOVER: 2, URGENT_CHOICE: 3 };
        const ORDER_TYPE = { NORMAL: 0, URGENT: 1 };

        // „Ç≤„Éº„É†„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
        let game = {
            state: GAME_STATE.TITLE,
            score: 0,
            timeLeft: 60,
            currentOrder: null,
            pendingUrgent: null,     // Ââ≤„ÇäËæº„ÅøÂæÖ„Å°„ÅÆÁ∑äÊÄ•„Ç™„Éº„ÉÄ„Éº
            urgentTimer: 0,          // Ê¨°„ÅÆÁ∑äÊÄ•Áô∫Áîü„Åæ„Åß„ÅÆÊôÇÈñì
            completedOrders: 0,
            urgentCompleted: 0,
            urgentMissed: 0,
            level: 1,
            shelves: [],
            forklifts: [],
            shippingStation: null,
            cameraX: 0,
            cameraY: 0,
            lastTime: 0,
            bgmEnabled: true,
            hitCooldown: 0,
            eventLog: [],
            flashEffect: null,
            telopText: null,
            telopTimer: 0,
            comboCount: 0,
            lastOrderTime: 0
        };

        // „Éó„É¨„Ç§„É§„Éº
        let player = {
            x: MAP_WIDTH / 2,
            y: MAP_HEIGHT - 200,
            width: 40,
            height: 50,
            speed: 5,
            direction: 'up',
            animFrame: 0,
            animTimer: 0,
            isPicking: false,
            pickTimer: 0,
            pickTarget: null,
            inventory: []
        };

        // ÂÖ•ÂäõÁä∂ÊÖã
        let keys = {};
        let touchDirs = { up: false, down: false, left: false, right: false };

        // ============================================
        // „Ç™„Éº„Éá„Ç£„Ç™„Ç∑„Çπ„ÉÜ„É†
        // ============================================
        
        let audioCtx = null;
        let bgmInterval = null;
        let bgmPlaying = false;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        const BGM_MELODY = [
            { note: 'C5', dur: 0.12 }, { note: 'E5', dur: 0.12 }, 
            { note: 'G5', dur: 0.12 }, { note: 'C6', dur: 0.24 },
            { note: 'G5', dur: 0.12 }, { note: 'E5', dur: 0.12 },
            { note: 'C5', dur: 0.12 }, { note: 'D5', dur: 0.12 },
            { note: 'F5', dur: 0.12 }, { note: 'A5', dur: 0.12 },
            { note: 'D6', dur: 0.24 }, { note: 'A5', dur: 0.12 },
            { note: 'F5', dur: 0.12 }, { note: 'D5', dur: 0.12 },
            { note: 'E5', dur: 0.12 }, { note: 'G5', dur: 0.12 },
            { note: 'B5', dur: 0.12 }, { note: 'E6', dur: 0.24 },
            { note: 'D6', dur: 0.12 }, { note: 'C6', dur: 0.24 },
            { note: null, dur: 0.12 }
        ];

        const NOTE_FREQ = {
            'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'G4': 392.00, 'A4': 440.00, 'B4': 493.88,
            'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 698.46, 'G5': 783.99, 'A5': 880.00, 'B5': 987.77,
            'C6': 1046.50, 'D6': 1174.66, 'E6': 1318.51
        };

        function startBGM() {
            if (!audioCtx || !game.bgmEnabled || bgmPlaying) return;
            bgmPlaying = true;
            
            let noteIndex = 0;
            let nextNoteTime = audioCtx.currentTime;

            function scheduleNotes() {
                while (nextNoteTime < audioCtx.currentTime + 0.2) {
                    const { note, dur } = BGM_MELODY[noteIndex];
                    if (note && NOTE_FREQ[note]) {
                        playBGMNote(NOTE_FREQ[note], dur * 0.9, nextNoteTime);
                    }
                    nextNoteTime += dur;
                    noteIndex = (noteIndex + 1) % BGM_MELODY.length;
                }
            }

            bgmInterval = setInterval(() => {
                if (game.state === GAME_STATE.PLAYING && game.bgmEnabled) {
                    scheduleNotes();
                }
            }, 100);
        }

        function playBGMNote(freq, duration, time) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'square';
            osc.frequency.setValueAtTime(freq, time);
            gain.gain.setValueAtTime(0.04, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
            osc.start(time);
            osc.stop(time + duration);
        }

        function stopBGM() {
            if (bgmInterval) { clearInterval(bgmInterval); bgmInterval = null; }
            bgmPlaying = false;
        }

        function toggleBGM() {
            game.bgmEnabled = !game.bgmEnabled;
            soundToggle.textContent = game.bgmEnabled ? 'üîä' : 'üîá';
            if (!game.bgmEnabled) stopBGM();
            else if (game.state === GAME_STATE.PLAYING) startBGM();
        }

        function playSound(type) {
            if (!audioCtx) return;
            switch (type) {
                case 'pick':
                    playNote(600, 0.05, 'sine', 0);
                    playNote(800, 0.08, 'sine', 0.05);
                    playNote(1000, 0.1, 'sine', 0.12);
                    break;
                case 'complete':
                    playNote(523, 0.08, 'sine', 0);
                    playNote(659, 0.08, 'sine', 0.08);
                    playNote(784, 0.08, 'sine', 0.16);
                    playNote(1047, 0.15, 'sine', 0.24);
                    playNote(784, 0.08, 'sine', 0.4);
                    playNote(1047, 0.25, 'sine', 0.48);
                    break;
                case 'ship':
                    playNote(880, 0.1, 'sine', 0);
                    playNote(1100, 0.1, 'sine', 0.1);
                    playNote(1320, 0.1, 'sine', 0.2);
                    playNote(1760, 0.3, 'sine', 0.3);
                    break;
                case 'levelup':
                    playNote(523, 0.08, 'square', 0);
                    playNote(659, 0.08, 'square', 0.08);
                    playNote(784, 0.08, 'square', 0.16);
                    playNote(1047, 0.12, 'square', 0.24);
                    playNote(1318, 0.12, 'square', 0.36);
                    playNote(1568, 0.25, 'square', 0.48);
                    break;
                case 'wrong':
                    playNote(200, 0.12, 'sawtooth', 0, 0.1);
                    playNote(150, 0.15, 'sawtooth', 0.1, 0.1);
                    break;
                case 'hit':
                    playNote(120, 0.08, 'sawtooth', 0, 0.15);
                    playNote(80, 0.15, 'sawtooth', 0.08, 0.15);
                    playNote(60, 0.2, 'sawtooth', 0.2, 0.1);
                    break;
                case 'urgent':
                    // Á∑äÊÄ•„Ç¢„É©„Éº„É†Èü≥
                    for (let i = 0; i < 3; i++) {
                        playNote(880, 0.1, 'square', i * 0.25, 0.12);
                        playNote(660, 0.1, 'square', i * 0.25 + 0.12, 0.12);
                    }
                    break;
                case 'urgentAccept':
                    playNote(440, 0.1, 'sine', 0);
                    playNote(660, 0.1, 'sine', 0.1);
                    playNote(880, 0.15, 'sine', 0.2);
                    break;
                case 'urgentMiss':
                    playNote(300, 0.15, 'sawtooth', 0, 0.1);
                    playNote(200, 0.2, 'sawtooth', 0.15, 0.1);
                    playNote(150, 0.3, 'sawtooth', 0.35, 0.08);
                    break;
                case 'gameover':
                    playNote(400, 0.2, 'sine', 0);
                    playNote(350, 0.2, 'sine', 0.2);
                    playNote(300, 0.2, 'sine', 0.4);
                    playNote(250, 0.4, 'sine', 0.6);
                    break;
            }
        }

        function playNote(freq, duration, waveType, delay, volume = 0.12) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = waveType;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
            gain.gain.setValueAtTime(0, audioCtx.currentTime + delay);
            gain.gain.linearRampToValueAtTime(volume, audioCtx.currentTime + delay + 0.01);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + delay + duration);
            osc.start(audioCtx.currentTime + delay);
            osc.stop(audioCtx.currentTime + delay + duration + 0.01);
        }

        // ============================================
        // „Ç§„Éô„É≥„Éà„É≠„Ç∞„ÉªÊºîÂá∫
        // ============================================

        function addEventLog(text, type = 'info') {
            game.eventLog.unshift({ text, type, time: 3.5 });
            if (game.eventLog.length > 6) game.eventLog.pop();
        }

        function showTelop(text, duration = 2) {
            game.telopText = text;
            game.telopTimer = duration;
        }

        function triggerFlash(color, duration = 0.3) {
            game.flashEffect = { color, duration, timer: duration };
        }

        // ============================================
        // „Éû„ÉÉ„ÉóÁîüÊàê
        // ============================================
        
        function generateMap() {
            game.shelves = [];
            game.forklifts = [];

            const shelfWidth = 100;
            const shelfHeight = 70;
            const gapX = 260;
            const gapY = 220;
            const startX = 150;
            const startY = 180;

            const rows = 4;
            const cols = 6;

            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const x = startX + col * gapX;
                    const y = startY + row * gapY;
                    const typeIndex = (row * cols + col) % ITEM_TYPES.length;
                    
                    game.shelves.push({
                        x, y,
                        width: shelfWidth,
                        height: shelfHeight,
                        itemType: typeIndex,
                        stock: 99
                    });
                }
            }

            // Âá∫Ëç∑„Çπ„ÉÜ„Éº„Ç∑„Éß„É≥
            game.shippingStation = {
                x: MAP_WIDTH / 2 - 80,
                y: MAP_HEIGHT - 120,
                width: 160,
                height: 80
            };

            createForklifts();
        }

        function createForklifts() {
            game.forklifts = [];
            const forkliftCount = Math.min(2 + Math.floor(game.level / 2), 8);
            
            const routes = [
                { startX: 80, startY: 280, endX: MAP_WIDTH - 120, endY: 280, dir: 'h' },
                { startX: 80, startY: 500, endX: MAP_WIDTH - 120, endY: 500, dir: 'h' },
                { startX: 80, startY: 720, endX: MAP_WIDTH - 120, endY: 720, dir: 'h' },
                { startX: 80, startY: 940, endX: MAP_WIDTH - 120, endY: 940, dir: 'h' },
                { startX: 350, startY: 130, endX: 350, endY: MAP_HEIGHT - 180, dir: 'v' },
                { startX: 750, startY: 130, endX: 750, endY: MAP_HEIGHT - 180, dir: 'v' },
                { startX: 1150, startY: 130, endX: 1150, endY: MAP_HEIGHT - 180, dir: 'v' },
                { startX: 1550, startY: 130, endX: 1550, endY: MAP_HEIGHT - 180, dir: 'v' }
            ];

            for (let i = 0; i < forkliftCount; i++) {
                const route = routes[i % routes.length];
                const baseSpeed = 1.8 + game.level * 0.2;
                game.forklifts.push({
                    x: route.dir === 'h' ? route.startX + Math.random() * 300 : route.startX,
                    y: route.dir === 'v' ? route.startY + Math.random() * 300 : route.startY,
                    width: 45,
                    height: 65,
                    speed: baseSpeed + Math.random() * 0.5,
                    direction: Math.random() < 0.5 ? 1 : -1,
                    route
                });
            }
        }

        // ============================================
        // „Ç™„Éº„ÉÄ„ÉºÁÆ°ÁêÜ
        // ============================================

        function createOrder(type) {
            const isUrgent = type === ORDER_TYPE.URGENT;
            const itemCount = isUrgent 
                ? 2 + Math.floor(game.level / 4) 
                : 3 + Math.floor(game.level / 3);
            const deadline = isUrgent 
                ? 12 + Math.floor(Math.random() * 8)  // 12„Äú20Áßí
                : 25 + Math.floor(Math.random() * 15); // 25„Äú40Áßí
            const basePoints = isUrgent ? 2500 : 1000;
            
            const usedTypes = new Set();
            const items = [];
            
            for (let i = 0; i < Math.min(itemCount, 5); i++) {
                let typeIndex;
                do {
                    typeIndex = Math.floor(Math.random() * ITEM_TYPES.length);
                } while (usedTypes.has(typeIndex));
                usedTypes.add(typeIndex);
                
                const required = isUrgent ? 1 : 1 + Math.floor(Math.random() * 2);
                items.push({ type: typeIndex, required, collected: 0 });
            }
            
            return {
                id: Date.now() + Math.random(),
                type,
                items,
                deadline,
                maxDeadline: deadline,
                basePoints,
                readyToShip: false
            };
        }

        function startNewOrder() {
            game.currentOrder = createOrder(ORDER_TYPE.NORMAL);
            player.inventory = [];
            addEventLog('üìã Êñ∞Ë¶è„Ç™„Éº„ÉÄ„ÉºÂèó‰ªò', 'info');
        }

        function triggerUrgentOrder() {
            // Á∑äÊÄ•„Ç™„Éº„ÉÄ„ÉºÂâ≤„ÇäËæº„ÅøÔºÅ
            game.pendingUrgent = createOrder(ORDER_TYPE.URGENT);
            game.state = GAME_STATE.URGENT_CHOICE;
            playSound('urgent');
            triggerFlash('rgba(255, 0, 0, 0.4)', 0.5);
            showTelop('üö® Á∑äÊÄ•„Ç™„Éº„ÉÄ„ÉºÂâ≤„ÇäËæº„ÅøÔºÅ', 1);
            addEventLog('üö® Á∑äÊÄ•„Ç™„Éº„ÉÄ„ÉºÁô∫ÁîüÔºÅ', 'urgent');
            
            // „Çπ„Éû„ÉõÁî®„Éú„Çø„É≥Ë°®Á§∫
            urgentBtns.style.display = 'flex';
        }

        function acceptUrgent() {
            // Á∑äÊÄ•„ÇíÂèó„Åë„Çã ‚Üí ‰ªä„ÅÆ„Ç™„Éº„ÉÄ„Éº„ÅØÁ†¥Ê£Ñ
            addEventLog('‚ö° Á∑äÊÄ•„Ç™„Éº„ÉÄ„ÉºÂèóË´æÔºÅ', 'urgent');
            game.currentOrder = game.pendingUrgent;
            game.pendingUrgent = null;
            player.inventory = [];
            game.state = GAME_STATE.PLAYING;
            urgentBtns.style.display = 'none';
            playSound('urgentAccept');
            showTelop('üî¥ Á∑äÊÄ•„Ç™„Éº„ÉÄ„ÉºÈñãÂßãÔºÅ', 1.5);
            
            // Ê¨°„ÅÆÁ∑äÊÄ•„Åæ„Åß„ÅÆÊôÇÈñì„Çí„É™„Çª„ÉÉ„Éà
            resetUrgentTimer();
        }

        function rejectUrgent() {
            // Á∑äÊÄ•„ÇíÁÑ°Ë¶ñ ‚Üí „Éö„Éä„É´„ÉÜ„Ç£
            addEventLog('‚ùå Á∑äÊÄ•„Ç™„Éº„ÉÄ„ÉºÊãíÂê¶ -5Áßí', 'danger');
            game.timeLeft -= 5;
            game.urgentMissed++;
            game.pendingUrgent = null;
            game.state = GAME_STATE.PLAYING;
            urgentBtns.style.display = 'none';
            playSound('urgentMiss');
            triggerFlash('rgba(255, 100, 0, 0.4)', 0.3);
            showTelop('‚è≠ „Ç™„Éº„ÉÄ„ÉºÁ∂öË°å (-5Áßí)', 1);
            
            // Ê¨°„ÅÆÁ∑äÊÄ•„Åæ„Åß„ÅÆÊôÇÈñì„Çí„É™„Çª„ÉÉ„Éà
            resetUrgentTimer();
        }

        function resetUrgentTimer() {
            // „É¨„Éô„É´„Å´Âøú„Åò„Å¶Á∑äÊÄ•„ÅÆÈ†ªÂ∫¶„Åå‰∏ä„Åå„Çã
            const minTime = Math.max(12, 25 - game.level * 2);
            const maxTime = Math.max(20, 40 - game.level * 3);
            game.urgentTimer = minTime + Math.random() * (maxTime - minTime);
        }

        // ============================================
        // „Éî„ÉÉ„Ç≠„É≥„Ç∞Âá¶ÁêÜ
        // ============================================

        function tryPick() {
            if (player.isPicking || game.state !== GAME_STATE.PLAYING) return;
            
            // Âá∫Ëç∑„Çπ„ÉÜ„Éº„Ç∑„Éß„É≥„Å´„ÅÑ„ÇãÂ†¥Âêà„ÅØÁ¥çÂìÅÂá¶ÁêÜ
            if (isNearShippingStation()) {
                tryShip();
                return;
            }
            
            // Ëøë„Åè„ÅÆÊ£ö„ÇíÊé¢„Åô
            const nearShelf = findNearShelf();
            if (!nearShelf) {
                addEventLog('Ê£ö„ÅåËøë„Åè„Å´„ÅÇ„Çä„Åæ„Åõ„Çì', 'warning');
                return;
            }
            
            const order = game.currentOrder;
            if (!order || order.readyToShip) {
                addEventLog('Á¥çÂìÅÂæÖ„Å°„Åß„Åô ‚Üí Âá∫Ëç∑Âè£„Å∏', 'warning');
                return;
            }
            
            const neededItem = order.items.find(item => 
                item.type === nearShelf.itemType && item.collected < item.required
            );
            
            if (!neededItem) {
                playSound('wrong');
                addEventLog('‚ùå Ë™§„Éî„ÉÉ„ÇØÔºÅ‰∏çË¶Å„Å™„Ç¢„Ç§„ÉÜ„É†', 'error');
                triggerFlash('rgba(255, 100, 0, 0.4)', 0.2);
                return;
            }
            
            // „Éî„ÉÉ„Ç≠„É≥„Ç∞ÈñãÂßã
            player.isPicking = true;
            player.pickTimer = 0.35;
            player.pickTarget = nearShelf;
            
            setTimeout(() => {
                if (player.isPicking && player.pickTarget === nearShelf) {
                    neededItem.collected++;
                    player.inventory.push({ type: nearShelf.itemType, orderId: order.id });
                    
                    const isUrgent = order.type === ORDER_TYPE.URGENT;
                    const points = (isUrgent ? 100 : 50) * game.level;
                    game.score += points;
                    
                    playSound('pick');
                    addEventLog(`‚úì ${ITEM_TYPES[nearShelf.itemType].emoji} +${points}`, 'success');
                    
                    // „Ç™„Éº„ÉÄ„ÉºÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
                    const allPicked = order.items.every(item => item.collected >= item.required);
                    if (allPicked) {
                        order.readyToShip = true;
                        playSound('complete');
                        showTelop('üì¶ „Éî„ÉÉ„ÇØÂÆå‰∫ÜÔºÅÂá∫Ëç∑Âè£„Å∏ÔºÅ', 2);
                        addEventLog('‚úÖ „Éî„ÉÉ„ÇØÂÆå‰∫Ü ‚Üí Âá∫Ëç∑Âè£„Å∏', 'success');
                    }
                }
                player.isPicking = false;
                player.pickTarget = null;
            }, 350);
        }

        function findNearShelf() {
            const px = player.x + player.width / 2;
            const py = player.y + player.height / 2;
            
            for (let shelf of game.shelves) {
                const sx = shelf.x + shelf.width / 2;
                const sy = shelf.y + shelf.height / 2;
                const dist = Math.sqrt((px - sx) ** 2 + (py - sy) ** 2);
                if (dist < 80) return shelf;
            }
            return null;
        }

        function isNearShippingStation() {
            const station = game.shippingStation;
            const px = player.x + player.width / 2;
            const py = player.y + player.height / 2;
            const sx = station.x + station.width / 2;
            const sy = station.y + station.height / 2;
            return Math.abs(px - sx) < 100 && Math.abs(py - sy) < 80;
        }

        function tryShip() {
            const order = game.currentOrder;
            if (!order || !order.readyToShip) {
                addEventLog('Á¥çÂìÅ„Åô„Çã„Ç™„Éº„ÉÄ„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'warning');
                return;
            }
            
            const isUrgent = order.type === ORDER_TYPE.URGENT;
            const timeBonus = Math.max(0, Math.ceil(order.deadline));
            const points = (order.basePoints + timeBonus * 100) * game.level;
            
            // „Ç≥„É≥„Éú„Éú„Éº„Éä„Çπ
            const now = Date.now();
            if (now - game.lastOrderTime < 15000) {
                game.comboCount++;
            } else {
                game.comboCount = 1;
            }
            game.lastOrderTime = now;
            
            const comboBonus = game.comboCount > 1 ? Math.floor(points * (game.comboCount - 1) * 0.1) : 0;
            const totalPoints = points + comboBonus;
            
            game.score += totalPoints;
            game.completedOrders++;
            if (isUrgent) game.urgentCompleted++;
            
            playSound('ship');
            triggerFlash('rgba(0, 255, 100, 0.3)', 0.3);
            
            let msg = `üöö Âá∫Ëç∑ÂÆå‰∫ÜÔºÅ+${totalPoints.toLocaleString()}`;
            if (game.comboCount > 1) msg += ` (${game.comboCount}„Ç≥„É≥„Éú!)`;
            showTelop(msg, 2);
            addEventLog(msg, 'success');
            
            player.inventory = [];
            
            // „Éú„Éº„Éä„ÇπÊôÇÈñì
            game.timeLeft += isUrgent ? 10 : 6;
            
            // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„ÉÅ„Çß„ÉÉ„ÇØ
            const newLevel = Math.floor(game.completedOrders / 3) + 1;
            if (newLevel > game.level) {
                game.level = newLevel;
                playSound('levelup');
                showTelop(`‚¨ÜÔ∏è „É¨„Éô„É´ ${game.level}ÔºÅ`, 2);
                addEventLog(`üéâ „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅLv.${game.level}`, 'levelup');
                createForklifts();
            }
            
            // Êñ∞„Åó„ÅÑÈÄöÂ∏∏„Ç™„Éº„ÉÄ„ÉºÈñãÂßã
            startNewOrder();
        }

        // ============================================
        // „Éï„Ç©„Éº„ÇØ„É™„Éï„Éà
        // ============================================

        function updateForklifts(deltaTime) {
            game.forklifts.forEach(fl => {
                const route = fl.route;
                if (route.dir === 'h') {
                    fl.x += fl.speed * fl.direction;
                    if (fl.x >= route.endX) fl.direction = -1;
                    if (fl.x <= route.startX) fl.direction = 1;
                } else {
                    fl.y += fl.speed * fl.direction;
                    if (fl.y >= route.endY) fl.direction = -1;
                    if (fl.y <= route.startY) fl.direction = 1;
                }
            });
        }

        function checkForkliftCollision() {
            if (game.hitCooldown > 0 || player.isPicking) return;

            const playerRect = {
                x: player.x + 5, y: player.y + 10,
                width: player.width - 10, height: player.height - 10
            };

            for (let fl of game.forklifts) {
                if (rectCollision(playerRect, fl)) {
                    game.timeLeft -= 5;
                    game.hitCooldown = 2;
                    playSound('hit');
                    triggerFlash('rgba(255, 0, 0, 0.5)', 0.4);
                    showTelop('‚ö†Ô∏è „Éí„É§„É™„Éè„ÉÉ„ÉàÁô∫ÁîüÔºÅ -5Áßí', 1.5);
                    addEventLog('‚ö†Ô∏è „Éï„Ç©„Éº„ÇØ„É™„Éï„ÉàÊé•Ëß¶ÔºÅ-5Áßí', 'danger');
                    
                    const pushX = player.x - (fl.x + fl.width / 2);
                    const pushY = player.y - (fl.y + fl.height / 2);
                    const dist = Math.sqrt(pushX * pushX + pushY * pushY) || 1;
                    player.x += (pushX / dist) * 60;
                    player.y += (pushY / dist) * 60;
                    player.x = Math.max(10, Math.min(MAP_WIDTH - player.width - 10, player.x));
                    player.y = Math.max(100, Math.min(MAP_HEIGHT - player.height - 10, player.y));
                    return;
                }
            }
        }

        // ============================================
        // Ë°ùÁ™ÅÂà§ÂÆö
        // ============================================

        function rectCollision(a, b) {
            return a.x < b.x + b.width && a.x + a.width > b.x &&
                   a.y < b.y + b.height && a.y + a.height > b.y;
        }

        function checkShelfCollision(newX, newY) {
            const playerRect = {
                x: newX + 8, y: newY + 20,
                width: player.width - 16, height: player.height - 20
            };
            for (let shelf of game.shelves) {
                if (rectCollision(playerRect, shelf)) return true;
            }
            return false;
        }

        // ============================================
        // „Ç´„É°„É©
        // ============================================

        function updateCamera() {
            let targetX = player.x - SCREEN_WIDTH / 2 + player.width / 2;
            let targetY = player.y - SCREEN_HEIGHT / 2 + player.height / 2;
            targetX = Math.max(0, Math.min(MAP_WIDTH - SCREEN_WIDTH, targetX));
            targetY = Math.max(0, Math.min(MAP_HEIGHT - SCREEN_HEIGHT, targetY));
            game.cameraX += (targetX - game.cameraX) * 0.12;
            game.cameraY += (targetY - game.cameraY) * 0.12;
        }

        // ============================================
        // ÂÖ•Âäõ
        // ============================================

        window.addEventListener('keydown', (e) => {
            keys[e.code] = true;
            
            if (e.code === 'Space') {
                canvas.focus();
                initAudio();
                if (game.state === GAME_STATE.PLAYING) {
                    tryPick();
                } else if (game.state === GAME_STATE.TITLE || game.state === GAME_STATE.GAMEOVER) {
                    startGame();
                }
                e.preventDefault();
            }
            
            // Á∑äÊÄ•ÈÅ∏Êäû
            if (game.state === GAME_STATE.URGENT_CHOICE) {
                if (e.code === 'KeyY') {
                    acceptUrgent();
                    e.preventDefault();
                } else if (e.code === 'KeyN') {
                    rejectUrgent();
                    e.preventDefault();
                }
            }
            
            if (e.code === 'KeyM') toggleBGM();
            
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'KeyW', 'KeyA', 'KeyS', 'KeyD'].includes(e.code)) {
                e.preventDefault();
            }
        });

        window.addEventListener('keyup', (e) => { keys[e.code] = false; });

        // „Çø„ÉÉ„ÉÅÊìç‰Ωú
        document.querySelectorAll('.dpad-btn').forEach(btn => {
            const dir = btn.dataset.dir;
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                touchDirs[dir] = true;
                btn.classList.add('active');
            });
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                touchDirs[dir] = false;
                btn.classList.remove('active');
            });
            btn.addEventListener('touchcancel', () => {
                touchDirs[dir] = false;
                btn.classList.remove('active');
            });
        });

        actionBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            initAudio();
            if (game.state === GAME_STATE.PLAYING) tryPick();
            actionBtn.classList.add('active');
        });
        actionBtn.addEventListener('touchend', () => actionBtn.classList.remove('active'));

        acceptBtn.addEventListener('click', () => { if (game.state === GAME_STATE.URGENT_CHOICE) acceptUrgent(); });
        rejectBtn.addEventListener('click', () => { if (game.state === GAME_STATE.URGENT_CHOICE) rejectUrgent(); });
        acceptBtn.addEventListener('touchstart', (e) => { e.preventDefault(); if (game.state === GAME_STATE.URGENT_CHOICE) acceptUrgent(); });
        rejectBtn.addEventListener('touchstart', (e) => { e.preventDefault(); if (game.state === GAME_STATE.URGENT_CHOICE) rejectUrgent(); });

        startBtn.addEventListener('click', () => { initAudio(); if (game.state !== GAME_STATE.PLAYING) startGame(); });
        startBtn.addEventListener('touchstart', (e) => { e.preventDefault(); initAudio(); if (game.state !== GAME_STATE.PLAYING) startGame(); });
        soundToggle.addEventListener('click', () => { initAudio(); toggleBGM(); });
        canvas.addEventListener('click', () => canvas.focus());

        // ============================================
        // „Ç≤„Éº„É†ÈñãÂßã
        // ============================================

        function startGame() {
            game.state = GAME_STATE.PLAYING;
            game.score = 0;
            game.timeLeft = 60;
            game.completedOrders = 0;
            game.urgentCompleted = 0;
            game.urgentMissed = 0;
            game.level = 1;
            game.hitCooldown = 0;
            game.eventLog = [];
            game.flashEffect = null;
            game.telopText = null;
            game.comboCount = 0;
            game.lastOrderTime = 0;
            game.pendingUrgent = null;
            
            player.x = MAP_WIDTH / 2;
            player.y = MAP_HEIGHT - 200;
            player.inventory = [];
            player.isPicking = false;
            
            generateMap();
            startNewOrder();
            resetUrgentTimer();
            
            game.cameraX = player.x - SCREEN_WIDTH / 2;
            game.cameraY = player.y - SCREEN_HEIGHT / 2;
            game.lastTime = performance.now();
            
            startBtn.style.display = 'none';
            urgentBtns.style.display = 'none';
            startBGM();
            
            addEventLog('üéÆ „Ç≤„Éº„É†„Çπ„Çø„Éº„ÉàÔºÅ', 'info');
            showTelop('„Éî„ÉÉ„Ç≠„É≥„Ç∞ÈñãÂßãÔºÅ', 1.5);
        }

        // ============================================
        // Êõ¥Êñ∞
        // ============================================

        function update(deltaTime) {
            if (game.state === GAME_STATE.URGENT_CHOICE) {
                // Á∑äÊÄ•ÈÅ∏Êäû‰∏≠„ÅØÊôÇÈñì„ÅåÈÄ≤„ÇÄÔºà„Éó„É¨„ÉÉ„Ç∑„É£„ÉºÔºâ
                if (game.pendingUrgent) {
                    game.pendingUrgent.deadline -= deltaTime;
                    if (game.pendingUrgent.deadline <= 0) {
                        // ÈÅ∏Êäû„Åó„Å™„Åã„Å£„Åü ‚Üí Ëá™ÂãïÊãíÂê¶
                        rejectUrgent();
                    }
                }
                return;
            }
            
            if (game.state !== GAME_STATE.PLAYING) return;

            // „Çø„Ç§„Éû„ÉºÊõ¥Êñ∞
            game.timeLeft -= deltaTime;
            if (game.hitCooldown > 0) game.hitCooldown -= deltaTime;
            
            // „Ç™„Éº„ÉÄ„ÉºÁ∑†ÂàáÊõ¥Êñ∞
            if (game.currentOrder && !game.currentOrder.readyToShip) {
                game.currentOrder.deadline -= deltaTime;
                if (game.currentOrder.deadline <= 0) {
                    addEventLog('‚è∞ „Ç™„Éº„ÉÄ„ÉºÊúüÈôêÂàá„ÇåÔºÅ-3Áßí', 'danger');
                    triggerFlash('rgba(255, 150, 0, 0.3)', 0.3);
                    game.timeLeft -= 3;
                    playSound('wrong');
                    startNewOrder();
                }
            }
            
            // Á∑äÊÄ•„Ç™„Éº„ÉÄ„Éº„Çø„Ç§„Éû„Éº
            game.urgentTimer -= deltaTime;
            if (game.urgentTimer <= 0 && !game.pendingUrgent) {
                triggerUrgentOrder();
            }
            
            // „Ç®„Éï„Çß„ÇØ„ÉàÊõ¥Êñ∞
            if (game.flashEffect) {
                game.flashEffect.timer -= deltaTime;
                if (game.flashEffect.timer <= 0) game.flashEffect = null;
            }
            if (game.telopTimer > 0) {
                game.telopTimer -= deltaTime;
                if (game.telopTimer <= 0) game.telopText = null;
            }
            game.eventLog.forEach(log => log.time -= deltaTime);
            game.eventLog = game.eventLog.filter(log => log.time > 0);
            
            // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„ÉÅ„Çß„ÉÉ„ÇØ
            if (game.timeLeft <= 0) {
                game.timeLeft = 0;
                game.state = GAME_STATE.GAMEOVER;
                stopBGM();
                playSound('gameover');
                startBtn.textContent = 'üîÑ „É™„Éà„É©„Ç§';
                startBtn.style.display = 'block';
                return;
            }

            // „Éî„ÉÉ„Ç≠„É≥„Ç∞‰∏≠„ÅØÁßªÂãï‰∏çÂèØ
            if (player.isPicking) {
                player.pickTimer -= deltaTime;
                return;
            }

            // ÁßªÂãï
            let dx = 0, dy = 0;
            if (keys['ArrowUp'] || keys['KeyW'] || touchDirs.up) dy = -player.speed;
            if (keys['ArrowDown'] || keys['KeyS'] || touchDirs.down) dy = player.speed;
            if (keys['ArrowLeft'] || keys['KeyA'] || touchDirs.left) dx = -player.speed;
            if (keys['ArrowRight'] || keys['KeyD'] || touchDirs.right) dx = player.speed;

            if (dx !== 0 && dy !== 0) { dx *= 0.707; dy *= 0.707; }

            if (dy < 0) player.direction = 'up';
            else if (dy > 0) player.direction = 'down';
            else if (dx < 0) player.direction = 'left';
            else if (dx > 0) player.direction = 'right';

            if (dx !== 0 || dy !== 0) {
                player.animTimer += deltaTime;
                if (player.animTimer > 0.08) {
                    player.animTimer = 0;
                    player.animFrame = (player.animFrame + 1) % 4;
                }
            } else {
                player.animFrame = 0;
            }

            let newX = player.x + dx;
            let newY = player.y + dy;
            newX = Math.max(10, Math.min(MAP_WIDTH - player.width - 10, newX));
            newY = Math.max(80, Math.min(MAP_HEIGHT - player.height - 10, newY));

            if (!checkShelfCollision(newX, player.y)) player.x = newX;
            if (!checkShelfCollision(player.x, newY)) player.y = newY;

            updateCamera();
            updateForklifts(deltaTime);
            checkForkliftCollision();
        }

        // ============================================
        // ÊèèÁîª
        // ============================================

        function draw() {
            ctx.fillStyle = '#f5f5dc';
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);

            if (game.state === GAME_STATE.TITLE) {
                drawTitle();
            } else {
                drawGame();
                if (game.state === GAME_STATE.URGENT_CHOICE) {
                    drawUrgentChoice();
                }
                if (game.state === GAME_STATE.GAMEOVER) {
                    drawGameOver();
                }
            }
        }

        function drawTitle() {
            const gradient = ctx.createLinearGradient(0, 0, 0, SCREEN_HEIGHT);
            gradient.addColorStop(0, '#1a1a3e');
            gradient.addColorStop(1, '#2a2a5e');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);

            // „Çø„Ç§„Éà„É´
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 38px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('üè≠ ÂÄâÂ∫´„Éî„ÉÉ„Ç≠„É≥„Ç∞', SCREEN_WIDTH/2, 50);

            // Â∑¶„Éë„Éç„É´ÔºöÈÅä„Å≥Êñπ
            const leftX = 40;
            const panelWidth = 420;
            
            // „Éë„Éç„É´ËÉåÊôØ
            ctx.fillStyle = 'rgba(255,255,255,0.08)';
            ctx.fillRect(leftX, 75, panelWidth, 250);
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 2;
            ctx.strokeRect(leftX, 75, panelWidth, 250);
            
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 18px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('üìñ ÈÅä„Å≥Êñπ', leftX + 15, 100);
            
            ctx.fillStyle = '#fff';
            ctx.font = '15px sans-serif';
            const howToPlay = [
                '‚ë† „Ç™„Éº„ÉÄ„Éº„Å´Êõ∏„Åã„Çå„ÅüÂïÜÂìÅ„ÇíÈõÜ„ÇÅ„Çã',
                '   ‚Üí Ê£ö„ÅÆÂâç„Åß SPACE „ÇíÊäº„Åó„Å¶„Éî„ÉÉ„ÇØ',
                '',
                '‚ë° ÂÖ®ÈÉ®ÈõÜ„ÇÅ„Åü„ÇâÂá∫Ëç∑Âè£„Å∏ÈÅã„Å∂',
                '   ‚Üí Âá∫Ëç∑Âè£„ÅÆÂâç„Åß SPACE „ÇíÊäº„Åó„Å¶Á¥çÂìÅ',
                '',
                '‚ë¢ Á∑†ÂàáÊôÇÈñìÂÜÖ„Å´Á¥çÂìÅ„Åô„Çã„Å®È´òÂæóÁÇπÔºÅ',
                '   ‚Üí ÊÆã„ÇäÊôÇÈñì„ÅåÂ§ö„ÅÑ„Åª„Å©„Éú„Éº„Éä„Çπ'
            ];
            howToPlay.forEach((text, i) => {
                ctx.fillStyle = text.startsWith('‚ë†') || text.startsWith('‚ë°') || text.startsWith('‚ë¢') ? '#4CAF50' : '#ccc';
                ctx.fillText(text, leftX + 15, 130 + i * 22);
            });

            // Âè≥„Éë„Éç„É´ÔºöÊìç‰ΩúÊñπÊ≥ï
            const rightX = 490;
            
            ctx.fillStyle = 'rgba(255,255,255,0.08)';
            ctx.fillRect(rightX, 75, panelWidth, 250);
            ctx.strokeStyle = '#ffd700';
            ctx.strokeRect(rightX, 75, panelWidth, 250);
            
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 18px sans-serif';
            ctx.fillText('üéÆ Êìç‰ΩúÊñπÊ≥ï', rightX + 15, 100);
            
            ctx.font = '15px sans-serif';
            const controls = [
                { key: '‚Üë‚Üì‚Üê‚Üí / WASD', action: 'ÁßªÂãï' },
                { key: 'SPACE', action: 'Ê£ö„Åß„Éî„ÉÉ„ÇØ / Âá∫Ëç∑Âè£„ÅßÁ¥çÂìÅ' },
                { key: 'Y / N', action: 'Á∑äÊÄ•„Ç™„Éº„ÉÄ„Éº„ÅÆÂèóË´æ/ÊãíÂê¶' },
                { key: 'M', action: 'BGM ON/OFF' }
            ];
            controls.forEach((c, i) => {
                const y = 130 + i * 40;
                ctx.fillStyle = '#ffd700';
                ctx.fillText(c.key, rightX + 15, y);
                ctx.fillStyle = '#fff';
                ctx.fillText(c.action, rightX + 15, y + 18);
            });

            // ‰∏ãÈÉ®ÔºöÁ∑äÊÄ•„Ç™„Éº„ÉÄ„Éº„Å®„Éö„Éä„É´„ÉÜ„Ç£
            const bottomY = 340;
            
            // Á∑äÊÄ•„Ç™„Éº„ÉÄ„ÉºË™¨Êòé
            ctx.fillStyle = 'rgba(180, 40, 40, 0.3)';
            ctx.fillRect(leftX, bottomY, 440, 100);
            ctx.strokeStyle = '#FF6B6B';
            ctx.lineWidth = 2;
            ctx.strokeRect(leftX, bottomY, 440, 100);
            
            ctx.fillStyle = '#FF6B6B';
            ctx.font = 'bold 16px sans-serif';
            ctx.fillText('üö® Á∑äÊÄ•„Ç™„Éº„ÉÄ„ÉºÔºà„É©„É≥„ÉÄ„É†„ÅßÂâ≤„ÇäËæº„ÅøÔºâ', leftX + 15, bottomY + 25);
            
            ctx.font = '14px sans-serif';
            ctx.fillStyle = '#fff';
            ctx.fillText('Y „ÅßÂèó„Åë„Çã ‚Üí ‰ªä„ÅÆ„ÇíÁ†¥Ê£Ñ„Åó„Å¶Á∑äÊÄ•Âá¶ÁêÜ', leftX + 25, bottomY + 50);
            ctx.fillText('              È´òÂæóÁÇπ & ÊôÇÈñì+10ÁßíÔºÅ', leftX + 25, bottomY + 68);
            ctx.fillStyle = '#aaa';
            ctx.fillText('N „ÅßÁÑ°Ë¶ñ ‚Üí Áèæ„Ç™„Éº„ÉÄ„ÉºÁ∂öË°åÔºà-5Áßí„Éö„Éä„É´„ÉÜ„Ç£Ôºâ', leftX + 25, bottomY + 90);

            // Ê≥®ÊÑè‰∫ãÈ†Ö
            ctx.fillStyle = 'rgba(255, 150, 0, 0.2)';
            ctx.fillRect(rightX, bottomY, 420, 100);
            ctx.strokeStyle = '#FFA500';
            ctx.strokeRect(rightX, bottomY, 420, 100);
            
            ctx.fillStyle = '#FFA500';
            ctx.font = 'bold 16px sans-serif';
            ctx.fillText('‚ö†Ô∏è Ê≥®ÊÑè', rightX + 15, bottomY + 25);
            
            ctx.font = '14px sans-serif';
            ctx.fillStyle = '#fff';
            ctx.fillText('üöú „Éï„Ç©„Éº„ÇØ„É™„Éï„Éà„Å´Êé•Ëß¶ ‚Üí -5Áßí', rightX + 25, bottomY + 50);
            ctx.fillText('‚è∞ „Ç™„Éº„ÉÄ„ÉºÁ∑†ÂàáÂàá„Çå ‚Üí -3Áßí', rightX + 25, bottomY + 70);
            ctx.fillText('‚ùå ÈñìÈÅï„Å£„ÅüÂïÜÂìÅ„Çí„Éî„ÉÉ„ÇØ ‚Üí Âèñ„Çå„Å™„ÅÑ', rightX + 25, bottomY + 90);

            // ÂïÜÂìÅ‰∏ÄË¶ßÔºàÂ∞è„Åï„ÅèÔºâ
            ctx.fillStyle = '#888';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('„ÄêÂèñÊâ±ÂïÜÂìÅ„Äë', SCREEN_WIDTH/2, 460);
            
            ITEM_TYPES.forEach((item, i) => {
                const x = SCREEN_WIDTH/2 - 210 + i * 62;
                const y = 485;
                ctx.fillStyle = item.color;
                ctx.beginPath();
                ctx.arc(x, y, 16, 0, Math.PI * 2);
                ctx.fill();
                ctx.font = '18px sans-serif';
                ctx.fillText(item.emoji, x, y + 6);
            });

            // „Çπ„Çø„Éº„Éà„Éú„Çø„É≥
            if (Math.floor(Date.now() / 500) % 2 === 0) {
                ctx.fillStyle = '#ffd700';
                ctx.font = 'bold 28px sans-serif';
                ctx.fillText('üéÆ SPACE „Åß„Çπ„Çø„Éº„Éà üéÆ', SCREEN_WIDTH/2, 555);
            } else {
                ctx.fillStyle = '#aa9500';
                ctx.font = 'bold 28px sans-serif';
                ctx.fillText('üéÆ SPACE „Åß„Çπ„Çø„Éº„Éà üéÆ', SCREEN_WIDTH/2, 555);
            }
        }

        function drawGame() {
            ctx.save();
            ctx.translate(-game.cameraX, -game.cameraY);

            drawFloor();
            drawShippingStation();
            game.shelves.forEach(s => drawShelf(s));
            game.forklifts.forEach(f => drawForklift(f));
            drawPlayer();

            ctx.restore();

            drawUI();
            drawEventLog();
            drawTelop();
            drawFlashEffect();
        }

        function drawFloor() {
            const tileSize = 100;
            for (let x = 0; x < MAP_WIDTH; x += tileSize) {
                for (let y = 0; y < MAP_HEIGHT; y += tileSize) {
                    ctx.fillStyle = (Math.floor(x / tileSize) + Math.floor(y / tileSize)) % 2 === 0 
                        ? '#e8e0c8' : '#ddd8c0';
                    ctx.fillRect(x, y, tileSize, tileSize);
                }
            }
            ctx.strokeStyle = '#ffd700';
            ctx.lineWidth = 3;
            ctx.setLineDash([20, 12]);
            for (let x = 240; x < MAP_WIDTH; x += 260) {
                ctx.beginPath();
                ctx.moveTo(x - 40, 100);
                ctx.lineTo(x - 40, MAP_HEIGHT - 150);
                ctx.stroke();
            }
            ctx.setLineDash([]);
        }

        function drawShippingStation() {
            const s = game.shippingStation;
            
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(s.x + 5, s.y + 5, s.width, s.height);
            
            ctx.fillStyle = '#2E7D32';
            ctx.fillRect(s.x, s.y, s.width, s.height);
            ctx.strokeStyle = '#1B5E20';
            ctx.lineWidth = 4;
            ctx.strokeRect(s.x, s.y, s.width, s.height);
            
            ctx.fillStyle = '#FFD700';
            for (let i = 0; i < 4; i++) {
                ctx.fillRect(s.x + 10 + i * 40, s.y, 15, s.height);
            }
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 18px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('üöö Âá∫Ëç∑Âè£', s.x + s.width/2, s.y + s.height/2 + 6);
        }

        function drawShelf(shelf) {
            const type = ITEM_TYPES[shelf.itemType];
            const order = game.currentOrder;
            const isNeeded = order && !order.readyToShip && 
                             order.items.some(item => item.type === shelf.itemType && item.collected < item.required);
            
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.fillRect(shelf.x + 5, shelf.y + 5, shelf.width, shelf.height);

            ctx.fillStyle = '#8B4513';
            ctx.fillRect(shelf.x, shelf.y, shelf.width, shelf.height);
            
            ctx.fillStyle = '#A0522D';
            for (let i = 0; i < 3; i++) {
                ctx.fillRect(shelf.x, shelf.y + i * 22, shelf.width, 7);
            }
            
            ctx.strokeStyle = isNeeded ? '#00FF00' : '#5D3A1A';
            ctx.lineWidth = isNeeded ? 4 : 2;
            ctx.strokeRect(shelf.x, shelf.y, shelf.width, shelf.height);

            ctx.fillStyle = type.color;
            ctx.fillRect(shelf.x + shelf.width/2 - 28, shelf.y - 38, 56, 34);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.strokeRect(shelf.x + shelf.width/2 - 28, shelf.y - 38, 56, 34);
            
            ctx.font = '26px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(type.emoji, shelf.x + shelf.width/2, shelf.y - 21);
            
            if (isNeeded && Math.floor(Date.now() / 400) % 2 === 0) {
                ctx.fillStyle = 'rgba(0, 255, 0, 0.2)';
                ctx.fillRect(shelf.x - 5, shelf.y - 5, shelf.width + 10, shelf.height + 10);
            }
        }

        function drawForklift(fl) {
            const x = fl.x, y = fl.y;
            
            ctx.fillStyle = 'rgba(0,0,0,0.25)';
            ctx.beginPath();
            ctx.ellipse(x + 22, y + fl.height + 4, 25, 9, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#FF8C00';
            ctx.fillRect(x + 5, y + 18, 35, 32);
            ctx.fillStyle = '#FFB347';
            ctx.fillRect(x + 7, y + 4, 30, 18);
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(x + 10, y + 7, 24, 11);
            ctx.fillStyle = '#555';
            ctx.fillRect(x, y + 50, 45, 7);
            ctx.fillRect(x + 4, y + 45, 7, 18);
            ctx.fillRect(x + 34, y + 45, 7, 18);
            ctx.fillStyle = '#333';
            ctx.beginPath();
            ctx.arc(x + 11, y + 56, 7, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(x + 34, y + 56, 7, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = Math.floor(Date.now() / 250) % 2 === 0 ? '#FF0000' : '#FF6666';
            ctx.beginPath();
            ctx.arc(x + 22, y - 2, 5, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawPlayer() {
            const x = Math.floor(player.x);
            const y = Math.floor(player.y);

            if (game.hitCooldown > 0 && Math.floor(Date.now() / 100) % 2 === 0) {
                ctx.globalAlpha = 0.4;
            }
            if (player.isPicking) {
                ctx.globalAlpha = 0.7;
            }

            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.beginPath();
            ctx.ellipse(x + player.width/2, y + player.height + 2, 18, 7, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = player.isPicking ? '#FFA500' : '#2196F3';
            ctx.fillRect(x + 8, y + 20, 24, 24);
            ctx.fillStyle = '#FFCC80';
            ctx.beginPath();
            ctx.arc(x + 20, y + 13, 13, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#FF5722';
            ctx.beginPath();
            ctx.arc(x + 20, y + 9, 14, Math.PI, 0);
            ctx.fill();
            ctx.fillRect(x + 4, y + 8, 32, 5);

            ctx.fillStyle = '#1565C0';
            const legOffset = Math.sin(player.animFrame * Math.PI / 2) * 4;
            ctx.fillRect(x + 8, y + 42, 9, 8 + legOffset);
            ctx.fillRect(x + 23, y + 42, 9, 8 - legOffset);

            ctx.fillStyle = '#333';
            if (player.direction === 'down') {
                ctx.fillRect(x + 14, y + 11, 3, 3);
                ctx.fillRect(x + 23, y + 11, 3, 3);
            } else if (player.direction === 'left') {
                ctx.fillRect(x + 10, y + 11, 3, 3);
            } else if (player.direction === 'right') {
                ctx.fillRect(x + 27, y + 11, 3, 3);
            }

            if (player.inventory.length > 0) {
                ctx.fillStyle = 'rgba(255,255,255,0.9)';
                ctx.beginPath();
                ctx.arc(x + 35, y + 5, 12, 0, Math.PI * 2);
                ctx.fill();
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#333';
                ctx.fillText(player.inventory.length.toString(), x + 35, y + 10);
            }

            ctx.globalAlpha = 1;
        }

        function drawUI() {
            // ‰∏äÈÉ®UI
            ctx.fillStyle = 'rgba(20, 30, 60, 0.95)';
            ctx.fillRect(0, 0, SCREEN_WIDTH, 95);
            ctx.fillStyle = '#ffd700';
            ctx.fillRect(0, 93, SCREEN_WIDTH, 3);

            // „Çπ„Ç≥„Ç¢„Éª„É¨„Éô„É´
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 15px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('SCORE', 12, 16);
            ctx.fillStyle = '#ffd700';
            ctx.font = 'bold 22px sans-serif';
            ctx.fillText(game.score.toLocaleString(), 12, 40);
            ctx.fillStyle = '#FF8C00';
            ctx.font = 'bold 13px sans-serif';
            ctx.fillText(`Lv.${game.level}`, 12, 58);
            ctx.fillStyle = '#4CAF50';
            ctx.fillText(`‚úÖ${game.completedOrders}‰ª∂`, 55, 58);
            
            // „Ç≥„É≥„ÉúË°®Á§∫
            if (game.comboCount > 1) {
                ctx.fillStyle = '#FF69B4';
                ctx.font = 'bold 12px sans-serif';
                ctx.fillText(`${game.comboCount}„Ç≥„É≥„Éú!`, 12, 75);
            }

            // ÊÆã„ÇäÊôÇÈñì
            const timeColor = game.timeLeft <= 15 ? '#FF5252' : '#ffd700';
            ctx.fillStyle = timeColor;
            ctx.textAlign = 'right';
            ctx.font = 'bold 32px sans-serif';
            ctx.fillText('‚è±' + Math.ceil(game.timeLeft), SCREEN_WIDTH - 12, 40);

            // „Ç™„Éº„ÉÄ„ÉºË°®Á§∫
            drawOrder();

            // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éí„É≥„Éà
            drawActionHint();

            // „Éü„Éã„Éû„ÉÉ„Éó
            drawMinimap();
        }

        function drawOrder() {
            const order = game.currentOrder;
            if (!order) return;
            
            const x = 140;
            const isUrgent = order.type === ORDER_TYPE.URGENT;
            const orderWidth = Math.min(order.items.length * 65 + 100, 500);
            
            // ËÉåÊôØ
            ctx.fillStyle = isUrgent 
                ? 'rgba(180, 40, 40, 0.9)' 
                : 'rgba(40, 80, 160, 0.9)';
            ctx.fillRect(x, 5, orderWidth, 85);
            
            // Á∑äÊÄ•„ÅÆÂ†¥Âêà„ÅØÁÇπÊªÖÊû†
            if (isUrgent && Math.floor(Date.now() / 300) % 2 === 0) {
                ctx.strokeStyle = '#FF0000';
                ctx.lineWidth = 4;
            } else {
                ctx.strokeStyle = isUrgent ? '#FF6B6B' : '#6B9FFF';
                ctx.lineWidth = 2;
            }
            ctx.strokeRect(x, 5, orderWidth, 85);
            
            // „Çø„Ç§„Éó„É©„Éô„É´
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 13px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(isUrgent ? 'üî¥ Á∑äÊÄ•„Ç™„Éº„ÉÄ„Éº' : 'üîµ ÈÄöÂ∏∏„Ç™„Éº„ÉÄ„Éº', x + 8, 20);
            
            // Á∑†Âàá
            const deadlineColor = order.deadline <= 5 ? '#FF0000' : (order.deadline <= 10 ? '#FFA500' : '#fff');
            ctx.fillStyle = deadlineColor;
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'right';
            if (order.readyToShip) {
                ctx.fillStyle = '#00FF00';
                ctx.fillText('üì¶ Á¥çÂìÅÂæÖ„Å°!', x + orderWidth - 8, 20);
            } else {
                ctx.fillText(`ÊÆã${Math.ceil(order.deadline)}Áßí`, x + orderWidth - 8, 20);
            }
            
            // „Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà
            const itemStartX = x + 10;
            order.items.forEach((item, i) => {
                const type = ITEM_TYPES[item.type];
                const ix = itemStartX + i * 62;
                const done = item.collected >= item.required;
                
                ctx.fillStyle = done ? 'rgba(76, 175, 80, 0.8)' : 'rgba(40, 40, 60, 0.8)';
                ctx.fillRect(ix, 28, 58, 55);
                ctx.strokeStyle = done ? '#4CAF50' : '#555';
                ctx.lineWidth = 1;
                ctx.strokeRect(ix, 28, 58, 55);
                
                ctx.font = '24px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(type.emoji, ix + 22, 55);
                
                ctx.font = 'bold 15px sans-serif';
                ctx.fillStyle = done ? '#fff' : '#ffd700';
                ctx.fillText(`${item.collected}/${item.required}`, ix + 42, 75);
                
                if (done) {
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 14px sans-serif';
                    ctx.fillText('‚úì', ix + 50, 40);
                }
            });
        }

        function drawActionHint() {
            let hint = '';
            let color = '#aaa';
            
            if (player.isPicking) {
                hint = 'üì¶ „Éî„ÉÉ„Ç≠„É≥„Ç∞‰∏≠...';
                color = '#FFA500';
            } else if (isNearShippingStation()) {
                const order = game.currentOrder;
                if (order && order.readyToShip) {
                    hint = 'üöö SPACE„ÅßÁ¥çÂìÅÔºÅ';
                    color = '#00FF00';
                } else {
                    hint = 'Âá∫Ëç∑Âè£Ôºà„Éî„ÉÉ„ÇØÂÆå‰∫ÜÂæå„Å´Á¥çÂìÅÔºâ';
                    color = '#888';
                }
            } else {
                const nearShelf = findNearShelf();
                if (nearShelf) {
                    hint = `üì¶ SPACE: ${ITEM_TYPES[nearShelf.itemType].emoji} „Çí„Éî„ÉÉ„ÇØ`;
                    color = '#4CAF50';
                }
            }
            
            if (hint) {
                ctx.fillStyle = color;
                ctx.font = 'bold 14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(hint, SCREEN_WIDTH / 2, SCREEN_HEIGHT - 12);
            }
            
            // „Çπ„Éû„ÉõÁî®„Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞
            if (isNearShippingStation() && game.currentOrder?.readyToShip) {
                actionBtn.innerHTML = 'üöö<br>Á¥çÂìÅ';
            } else {
                actionBtn.innerHTML = 'üì¶<br>„Éî„ÉÉ„ÇØ';
            }
        }

        function drawEventLog() {
            const x = SCREEN_WIDTH - 195;
            let y = 108;
            
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'left';
            
            game.eventLog.forEach(log => {
                const alpha = Math.min(1, log.time);
                ctx.globalAlpha = alpha;
                
                switch (log.type) {
                    case 'success': ctx.fillStyle = '#4CAF50'; break;
                    case 'error': case 'danger': ctx.fillStyle = '#FF5252'; break;
                    case 'warning': ctx.fillStyle = '#FFA500'; break;
                    case 'urgent': ctx.fillStyle = '#FF6B6B'; break;
                    case 'levelup': ctx.fillStyle = '#FFD700'; break;
                    default: ctx.fillStyle = '#fff';
                }
                
                ctx.fillText(log.text, x, y);
                y += 16;
            });
            
            ctx.globalAlpha = 1;
        }

        function drawTelop() {
            if (!game.telopText) return;
            
            const alpha = Math.min(1, game.telopTimer);
            ctx.globalAlpha = alpha;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
            ctx.fillRect(0, SCREEN_HEIGHT / 2 - 35, SCREEN_WIDTH, 70);
            
            ctx.fillStyle = '#FFD700';
            ctx.font = 'bold 30px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(game.telopText, SCREEN_WIDTH / 2, SCREEN_HEIGHT / 2 + 10);
            
            ctx.globalAlpha = 1;
        }

        function drawFlashEffect() {
            if (!game.flashEffect) return;
            
            const alpha = (game.flashEffect.timer / game.flashEffect.duration) * 0.6;
            ctx.fillStyle = game.flashEffect.color.replace(/[\d.]+\)$/, alpha + ')');
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
        }

        function drawUrgentChoice() {
            // ÊöóËª¢
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
            
            // Á∑äÊÄ•„Ç™„Éº„ÉÄ„ÉºË°®Á§∫
            const urgent = game.pendingUrgent;
            if (!urgent) return;
            
            ctx.fillStyle = 'rgba(150, 30, 30, 0.95)';
            ctx.fillRect(SCREEN_WIDTH/2 - 250, 150, 500, 280);
            ctx.strokeStyle = '#FF0000';
            ctx.lineWidth = 4;
            ctx.strokeRect(SCREEN_WIDTH/2 - 250, 150, 500, 280);
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 28px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('üö® Á∑äÊÄ•„Ç™„Éº„ÉÄ„ÉºÂâ≤„ÇäËæº„ÅøÔºÅ', SCREEN_WIDTH/2, 195);
            
            // Á∑†Âàá„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥
            ctx.fillStyle = '#FF6B6B';
            ctx.font = 'bold 18px sans-serif';
            ctx.fillText(`ÈÅ∏Êäû„Åæ„ÅßÊÆã„Çä ${Math.ceil(urgent.deadline)}Áßí`, SCREEN_WIDTH/2, 225);
            
            // „Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà
            const itemStartX = SCREEN_WIDTH/2 - (urgent.items.length * 35);
            urgent.items.forEach((item, i) => {
                const type = ITEM_TYPES[item.type];
                const ix = itemStartX + i * 70;
                
                ctx.fillStyle = type.color;
                ctx.beginPath();
                ctx.arc(ix + 30, 280, 28, 0, Math.PI * 2);
                ctx.fill();
                ctx.font = '30px sans-serif';
                ctx.fillText(type.emoji, ix + 30, 290);
                ctx.font = 'bold 14px sans-serif';
                ctx.fillStyle = '#fff';
                ctx.fillText(`x${item.required}`, ix + 30, 320);
            });
            
            // ÈÅ∏ÊäûËÇ¢
            ctx.fillStyle = '#fff';
            ctx.font = '16px sans-serif';
            ctx.fillText('Âèó„Åë„ÇãÔºö‰ªä„ÅÆ„Ç™„Éº„ÉÄ„Éº„ÇíÁ†¥Ê£Ñ„ÄÅÈ´òÂæóÁÇπ„ÉÅ„É£„É≥„Çπ', SCREEN_WIDTH/2, 365);
            ctx.fillText('ÁÑ°Ë¶ñÔºöÁèæ„Ç™„Éº„ÉÄ„ÉºÁ∂öË°å„ÄÅ„Åü„Å†„Åó-5Áßí„Éö„Éä„É´„ÉÜ„Ç£', SCREEN_WIDTH/2, 390);
            
            ctx.font = 'bold 20px sans-serif';
            ctx.fillStyle = '#FF6B6B';
            ctx.fillText('Y : Á∑äÊÄ•„ÇíÂèó„Åë„Çã', SCREEN_WIDTH/2 - 100, 420);
            ctx.fillStyle = '#888';
            ctx.fillText('N : ÁÑ°Ë¶ñ„Åó„Å¶Á∂öË°å', SCREEN_WIDTH/2 + 100, 420);
        }

        function drawMinimap() {
            const mapX = SCREEN_WIDTH - 108;
            const mapY = SCREEN_HEIGHT - 108;
            const mapW = 98;
            const mapH = 98;
            const scaleX = mapW / MAP_WIDTH;
            const scaleY = mapH / MAP_HEIGHT;

            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(mapX - 4, mapY - 4, mapW + 8, mapH + 8);
            ctx.fillStyle = '#ddd';
            ctx.fillRect(mapX, mapY, mapW, mapH);

            // Ê£ö
            ctx.fillStyle = '#8B4513';
            game.shelves.forEach(shelf => {
                ctx.fillRect(mapX + shelf.x * scaleX, mapY + shelf.y * scaleY,
                    Math.max(shelf.width * scaleX, 2), Math.max(shelf.height * scaleY, 2));
            });

            // Âá∫Ëç∑„Çπ„ÉÜ„Éº„Ç∑„Éß„É≥
            ctx.fillStyle = '#2E7D32';
            const s = game.shippingStation;
            ctx.fillRect(mapX + s.x * scaleX, mapY + s.y * scaleY, s.width * scaleX, s.height * scaleY);

            // „Éï„Ç©„Éº„ÇØ„É™„Éï„Éà
            ctx.fillStyle = '#FF8C00';
            game.forklifts.forEach(fl => {
                ctx.fillRect(mapX + fl.x * scaleX - 2, mapY + fl.y * scaleY - 2, 4, 4);
            });

            // ÂøÖË¶Å„Å™Ê£ö
            const order = game.currentOrder;
            if (order && !order.readyToShip) {
                ctx.fillStyle = '#00FF00';
                game.shelves.forEach(shelf => {
                    const needed = order.items.some(item => 
                        item.type === shelf.itemType && item.collected < item.required);
                    if (needed) {
                        ctx.fillRect(mapX + shelf.x * scaleX - 1, mapY + shelf.y * scaleY - 1,
                            shelf.width * scaleX + 2, shelf.height * scaleY + 2);
                    }
                });
            }

            // „Éó„É¨„Ç§„É§„Éº
            ctx.fillStyle = '#2196F3';
            ctx.beginPath();
            ctx.arc(mapX + (player.x + player.width/2) * scaleX,
                    mapY + (player.y + player.height/2) * scaleY, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 1.5;
            ctx.stroke();
        }

        function drawGameOver() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
            ctx.fillRect(0, 95, SCREEN_WIDTH, SCREEN_HEIGHT - 95);

            ctx.fillStyle = '#FF5252';
            ctx.font = 'bold 46px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('TIME UP!', SCREEN_WIDTH/2, 190);

            ctx.fillStyle = '#fff';
            ctx.font = '22px sans-serif';
            ctx.fillText('„Çπ„Ç≥„Ç¢: ' + game.score.toLocaleString(), SCREEN_WIDTH/2, 250);
            ctx.fillText(`ÂÆå‰∫Ü: ${game.completedOrders}‰ª∂ÔºàÁ∑äÊÄ•${game.urgentCompleted}‰ª∂Ôºâ`, SCREEN_WIDTH/2, 285);
            ctx.fillText('Âà∞ÈÅî„É¨„Éô„É´: ' + game.level, SCREEN_WIDTH/2, 320);
            
            if (game.urgentMissed > 0) {
                ctx.fillStyle = '#FF6B6B';
                ctx.font = '16px sans-serif';
                ctx.fillText(`Á∑äÊÄ•ÊãíÂê¶: ${game.urgentMissed}Âõû`, SCREEN_WIDTH/2, 350);
            }

            let rank = 'ü•â „Éñ„É≠„É≥„Ç∫';
            let rankColor = '#CD7F32';
            if (game.score >= 35000) { rank = 'üèÜ „Éû„Çπ„Çø„Éº'; rankColor = '#FFD700'; }
            else if (game.score >= 25000) { rank = 'ü•á „Ç¥„Éº„É´„Éâ'; rankColor = '#FFD700'; }
            else if (game.score >= 15000) { rank = 'ü•à „Ç∑„É´„Éê„Éº'; rankColor = '#C0C0C0'; }
            
            ctx.fillStyle = rankColor;
            ctx.font = 'bold 32px sans-serif';
            ctx.fillText(rank, SCREEN_WIDTH/2, 410);

            if (Math.floor(Date.now() / 500) % 2 === 0) {
                ctx.fillStyle = '#ffd700';
                ctx.font = 'bold 22px sans-serif';
                ctx.fillText('üéÆ SPACE „Åß„É™„Éà„É©„Ç§ üéÆ', SCREEN_WIDTH/2, 500);
            }
        }

        // ============================================
        // „Ç≤„Éº„É†„É´„Éº„Éó
        // ============================================

        function gameLoop(timestamp) {
            const deltaTime = (timestamp - game.lastTime) / 1000;
            game.lastTime = timestamp;
            update(Math.min(deltaTime, 0.1));
            draw();
            requestAnimationFrame(gameLoop);
        }

        game.lastTime = performance.now();
        requestAnimationFrame(gameLoop);
        setTimeout(() => canvas.focus(), 100);

    </script>
</body>

</html>
